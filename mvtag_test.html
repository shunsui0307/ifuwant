<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>クイックコール GTMテスト</title>
</head>
<body>

<script>!function(){var e=document.createElement("script");e.src="https://api.micovoice.com/api/v1/quick_calls/tag",e.async=!0,e.type="text/javascript",document.head.appendChild(e),window.__MV_DATALAYER__=window.__MV_DATALAYER__||[],window.mvtag=function(e,t){__MV_DATALAYER__.push({eventType:e,eventData:t,token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjYW1wYWlnblVpZCI6ImVkY2Y1NDQ1LTFjYmUtNGVmNy04OTIzLWEyYThlMzBjYmEwMSIsImlhdCI6MTc2NTM1NTQ4NH0.J55kS9VBI-pthVLtKyZnbKjNHc2g6okPrqgb9SXOfIY"})}}();</script>

<script>
(function() {
  /**
   * 日本語対応のBase64デコード関数
   * atobだけでは日本語が文字化けするため、decodeURIComponentでUTF-8に変換します
   */
  function safeBase64Decode(str) {
    try {
      if (!str) return null;
      // 1. atobでバイナリ文字列に変換
      // 2. 文字列内の各バイトを16進数エスケープに変換 (%xx)
      // 3. decodeURIComponent で日本語として復元
      return decodeURIComponent(escape(atob(str)));
    } catch (e) {
      console.error("Base64 decode error:", e);
      return null;
    }
  }

  // URLパラメータを取得
  var urlParams = new URLSearchParams(window.location.search);
  var encodedPhone = urlParams.get('utm_customid');
  var encodedName = urlParams.get('name');

  // 電話番号または名前のどちらかが存在する場合に実行
  if (encodedPhone || encodedName) {
    var decodedPhone = encodedPhone ? atob(encodedPhone) : ""; // 電話番号はASCII想定なのでatobのみでも可
    var decodedName = safeBase64Decode(encodedName) || "";

    // mvtag 関数を呼び出し
    mvtag("quick_call", {
      "phone_number": decodedPhone,
      "full_name": decodedName, // デコードした顧客名をセット
      "delay": 15
    });
  }
})();
</script>
